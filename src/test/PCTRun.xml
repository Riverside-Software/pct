<?xml version="1.0"?>

<project name="PCTRun-test" default="">

  <taskdef resource="PCT.properties" classpath="."/>

  <property environment="env"/>
  
  <!-- Test prowin32 on Windows, _progres on everything else -->
  <property name="graph" value="false" />
  <condition property="graph" value="true">
    <os family="windows" />
  </condition>
  
  <!-- Should throw BuildException : no procedure defined -->
  <target name="test1">
    <PCTRun graphicalMode="${graph}" dlcHome="${env.DLC}"/>
  </target>
   
   <!-- Simple case : displays 'Hello world' and exits properly -->
  <target name="test2">
    <echo file="sandbox/test.p">
      MESSAGE "Hello world!".
      RETURN "0".
    </echo>
    <PCTRun graphicalMode="${graph}" procedure="sandbox/test.p" dlcHome="${env.DLC}"/>
  </target>
  
  <!-- Simple case 2 : return value is 1 : Expect build exception -->
  <target name="test3">
    <echo file="sandbox/test.p">
      RETURN "1".
    </echo>
    <PCTRun graphicalMode="${graph}" procedure="sandbox/test.p" dlcHome="${env.DLC}"/>
  </target>
  
  <!-- Procedure doesn't exists : Expect build exception -->
  <target name="test4">
    <PCTRun graphicalMode="${graph}" procedure="sandbox/not_existing.p" dlcHome="${env.DLC}"/>	
  </target>
  
  <!-- Return value is non numeric : Expect build exception -->
  <target name="test5">
    <echo file="sandbox/test.p">
      RETURN "ABC".
    </echo>
  	<PCTRun graphicalMode="${graph}" procedure="sandbox/test.p" dlcHome="${env.DLC}"/>
  </target>
  
  <!-- Impossible to compile procedure : Expect build exception -->
  <target name="test6">
    <echo file="sandbox/test.p">
      En voila du code qui ne compile pas.
    </echo>
    <PCTRun graphicalMode="${graph}" procedure="sandbox/test.p" dlcHome="${env.DLC}"/>	
  </target>
  
  <!-- Test propath -->
  <target name="test7">
    <echo file="sandbox/test.p">
      RETURN "0".
    </echo>
    <PCTRun graphicalMode="${graph}" procedure="test.p" dlcHome="${env.DLC}">
      <propath>
        <pathelement location="sandbox"/>	
      </propath>	
    </PCTRun>
  </target>
  
  <!-- Test name containing ' and ~ -->
  <!-- See bug 837205 -->
  <target name="test8">
    <echo file="sandbox/wizz~~'~.p">
      RETURN "0".
    </echo>
    <PCTRun graphicalMode="${graph}" procedure="sandbox/wizz~~'~.p" dlcHome="${env.DLC}"/>
  </target>
  
  <!-- Test -param attribute -->
  <target name="test9init">
    <echo file="sandbox/test.p">
      MESSAGE "Hello" + SESSION:PARAMETER.
      RETURN "0".
    </echo>
  </target>
  <target name="test9">
    <PCTRun graphicalMode="${graph}" procedure="sandbox/test.p" dlcHome="${env.DLC}" parameter=" PCT"/>
  </target>
  <target name="test9bis">
    <PCTRun graphicalMode="${graph}" procedure="sandbox/test.p" dlcHome="${env.DLC}"/>
  </target>
  
  <!-- Test -yy attribute - Default is 1950 -->
  <target name="test10init">
    <echo file="sandbox/test.p">
      MESSAGE STRING(DATE("0101" + SESSION:PARAMETER), "99/99/9999").
      RETURN "0".
    </echo>
  </target>
  <target name="test10">
    <PCTRun graphicalMode="${graph}" procedure="sandbox/test.p" dlcHome="${env.DLC}" parameter="60" centuryYearOffset="1970"/>
  </target>
  <target name="test10bis">
    <PCTRun graphicalMode="${graph}" procedure="sandbox/test.p" dlcHome="${env.DLC}" parameter="60"/>
  </target>
  
  <!-- RETURN statement but no return value : considered OK -->
  <target name="test11">
    <echo file="sandbox/test.p">
      RETURN.
    </echo>
    <PCTRun graphicalMode="${graph}" procedure="sandbox/test.p" dlcHome="${env.DLC}"/>
  </target>
  
  <!-- Numsep and numdec tests -->
  <target name="test12-init">
    <echo file="sandbox/test.p">
  		MESSAGE 123.456.
  		RETURN "0".
    </echo>
  </target>
  <target name="test12-part1">
    <PCTRun graphicalMode="${graph}" procedure="sandbox/test.p" dlcHome="${env.DLC}" numsep="44" numdec="46"/>
  </target>
  <target name="test12-part2">
    <PCTRun graphicalMode="${graph}" procedure="sandbox/test.p" dlcHome="${env.DLC}" numsep="46" numdec="44"/>
  </target>
  <target name="test12-part3">
    <PCTRun graphicalMode="${graph}" procedure="sandbox/test.p" dlcHome="${env.DLC}" numsep="." numdec=","/>
  </target>
  <target name="test12-part4">
    <PCTRun graphicalMode="${graph}" procedure="sandbox/test.p" dlcHome="${env.DLC}" numsep="," numdec="."/>
  </target>
  
  <!-- Propath order -->
  <target name="test13-init">
  	<mkdir dir="sandbox/dir1"/>
  	<mkdir dir="sandbox/dir2"/>
  	<echo file="sandbox/dir1/test.i">
		MESSAGE "This is dir1".
  	</echo>
  	<echo file="sandbox/dir2/test.i">
  		MESSAGE "This is dir2".
  	</echo>
  	<echo file="sandbox/test.p">
  		{test.i}.
  		RETURN "0".
  	</echo>
  </target>
  <target name="test13-part1">
    <PCTRun graphicalMode="${graph}" procedure="sandbox/test.p" dlcHome="${env.DLC}">
      <propath>
      	<pathelement location="sandbox/dir1"/>
      	<pathelement location="sandbox/dir2"/>
      </propath>
    </PCTRun>
  </target>
  <target name="test13-part2">
    <PCTRun graphicalMode="${graph}" procedure="sandbox/test.p" dlcHome="${env.DLC}">
      <propath>
      	<pathelement location="sandbox/dir2"/>
      	<pathelement location="sandbox/dir1"/>
      </propath>
    </PCTRun>
  </target>

  <target name="test14-init">
    <echo file="sandbox/test.p">
      MESSAGE SESSION:PARAMETER.
      RETURN "0".
  	</echo>
  </target>
  <target name="test14-1">
  	<property name="prop1" value="prop1" />
  	<property name="prop2" value="prop2" />
  	<property name="prop3" value="'prop3'" />
    <PCTRun graphicalMode="${graph}" procedure="sandbox/test.p" dlcHome="${env.DLC}" parameter="-prop1=${prop1} -prop2=${prop2} -prop3=${prop3}" />
  </target>
  <target name="test14-2">
  	<property name="prop4" value="prop1" />
  	<property name="prop5" value="prop2" />
  	<property name="prop6" value='"prop3"' />
    <PCTRun graphicalMode="${graph}" procedure="sandbox/test.p" dlcHome="${env.DLC}" parameter="-prop1=${prop4} -prop2=${prop5} -prop3=${prop6}" />
  </target>
  <target name="test14-3">
  	<property name="prop7" value="prop1" />
  	<property name="prop8" value="prop2" />
  	<property name="prop9" value="prop 3" />
    <PCTRun graphicalMode="${graph}" procedure="sandbox/test.p" dlcHome="${env.DLC}" parameter="-prop1=${prop7} -prop2=${prop8} -prop3=${prop9}" />
  </target>
  
  <target name="test15">
    <echo file="sandbox/test.p">
      MESSAGE "This is a test".
      RETURN "0".
    </echo>
    <PCTRun graphicalMode="${graph}" procedure="sandbox/test.p" dlcHome="${env.DLC}">
      <PCTConnection dbName="testdb" dbDir="sandbox" singleUser="true"/>
    </PCTRun>
  </target>

  <target name="test16">
    <echo file="sandbox/test.p">
      OUTPUT TO VALUE(SESSION:TEMP-DIRECTORY + "/Output.txt").
      OUTPUT CLOSE.
      RETURN "0".
    </echo>
    <mkdir dir="sandbox/subdir" />
    <PCTRun graphicalMode="${graph}" procedure="sandbox/test.p" dlcHome="${env.DLC}" tempDir="sandbox/subdir" />
  </target>

  <target name="test17">
    <echo file="sandbox/test.p">
      OUTPUT TO VALUE("subdir2/Output.txt").
      OUTPUT CLOSE.
      RETURN "0".
    </echo>
    <mkdir dir="sandbox/subdir2" />
    <PCTRun graphicalMode="${graph}" procedure="test.p" dlcHome="${env.DLC}" baseDir="sandbox" />
  </target>
  
  <target name="test18">
    <echo file="sandbox/test.p">
      MESSAGE SESSION:CPRCODEOUT.
      RETURN "0".
    </echo>
    <PCTRun graphicalMode="${graph}" procedure="sandbox/test.p" dlcHome="${env.DLC}" cpInternal="iso8859-1">
      <PCTRunOption name="-cprcodeout" />
      <PCTRunOption name="utf-8" />
    </PCTRun>
  </target>
    
  <target name="test19">
    <echo file="sandbox/test.p">
      MESSAGE SESSION:CPRCODEOUT.
      RETURN "0".
    </echo>
    <PCTRun graphicalMode="${graph}" procedure="sandbox/test.p" dlcHome="${env.DLC}" cpInternal="iso8859-1">
      <PCTRunOption name="-cprcodeout utf-8" />
    </PCTRun>
  </target>

  <target name="test20">
    <echo file="sandbox/test.p">
      RETURN "0".
    </echo>
    <PCTRun graphicalMode="${graph}" procedure="sandbox/test.p" dlcHome="${env.DLC}">
      <PCTRunOption value="-zprofile sandbox/profiler.pf" />
    </PCTRun>
  </target>

  <target name="test21">
    <echo file="sandbox/test.p">
      RETURN "0".
    </echo>
    <echo file="sandbox/profiler.pf">
      -FILENAME sandbox/profiler.out
      -LISTINGS sandbox
    </echo>
    <PCTRun graphicalMode="${graph}" procedure="sandbox/test.p" dlcHome="${env.DLC}">
      <PCTRunOption name="-zprofile" value="sandbox/profiler.pf" />
    </PCTRun>
  </target>

  <target name="test22">
    <echo file="sandbox/test.p">
      MESSAGE SESSION:PARAMETER.
      RETURN "0".
    </echo>
    <PCTRun graphicalMode="${graph}" procedure="sandbox/test.p" dlcHome="${env.DLC}">
      <PCTRunOption name="-param" value="Message with spaces" />
    </PCTRun>
  </target>

</project>
