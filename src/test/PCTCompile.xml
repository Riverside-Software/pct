<?xml version="1.0"?>

<project name="PCTCompile-test" default="">

  <taskdef resource="PCT.properties" classpath="."/>

  <property environment="env"/>
  
  <!-- Test prowin32 on Windows, _progres on everything else -->
  <property name="graph" value="false" />
  <condition property="graph" value="true">
    <os family="windows" />
  </condition>
  
  <!-- Should throw BuildException : no dest dir -->
  <target name="test1">
    <PCTCompile graphicalMode="${graph}" dlcHome="${env.DLC}" propath="tty"/>
  </target>
  
  <!-- Do nothing : should not hurt -->
  <target name="test2">
    <PCTCompile graphicalMode="${graph}" destDir="build" dlcHome="${env.DLC}" propath="tty"/>
  </target>
  
  <!-- Simple compilation -->
  <target name="test3">
    <echo file="sandbox/test.p">
      MESSAGE "Hello world!".
      RETURN "0".
    </echo>
    <PCTCompile graphicalMode="${graph}" destDir="build" dlcHome="${env.DLC}" propath="tty">
      <fileset dir=".">
        <include name="sandbox/test.p"/>	
      </fileset>	
    </PCTCompile>	
  </target>
  
  <!-- Simple failed compilation -->
  <target name="test3bis">
  	<echo file="sandbox/temp.p">
      MESSGE "Hello world!".
  	</echo>
    <PCTCompile graphicalMode="${graph}" destDir="build" dlcHome="${env.DLC}" propath="tty">
      <fileset dir=".">
        <include name="sandbox/temp.p"/>	
      </fileset>
    </PCTCompile>	
  </target>
  
  <!-- Test MIN-SIZE attribute -->
  <target name="test4">
    <echo file="sandbox/test.p">
      MESSAGE "Hello world!".
      RETURN "0".
    </echo>
    <PCTCompile graphicalMode="${graph}" destDir="build" dlcHome="${env.DLC}" propath="tty">
      <fileset dir=".">
        <include name="sandbox/test.p"/>
      </fileset>
    </PCTCompile>
  </target>
  <target name="test4bis">
    <PCTCompile graphicalMode="${graph}" destDir="build" dlcHome="${env.DLC}" minSize="true" propath="tty">
      <fileset dir=".">
        <include name="sandbox/test.p"/>
      </fileset>
    </PCTCompile>	
  </target>
  
  <!-- Test escape string -->
  <target name="test5">
    <echo file="sandbox/wizz~~'~.p">
      MESSAGE "Hello world!".
      RETURN "0".
    </echo>
    <PCTCompile graphicalMode="${graph}" destDir="build" dlcHome="${env.DLC}" propath="tty">
      <fileset dir=".">
        <include name="sandbox/wizz~~'~.p"/>
      </fileset>
    </PCTCompile>
  </target>

  <!-- Test no recompile if file not changed (.r timestamp based) -->
  <target name="test6init">
  	<echo file="sandbox/temp.p">
      MESSAGE "Hello world".
  	</echo>
  </target>
  <target name="test6">
    <PCTCompile graphicalMode="${graph}" destDir="build" dlcHome="${env.DLC}" propath="tty">
      <fileset dir=".">
        <include name="sandbox/temp.p"/>	
      </fileset>	
    </PCTCompile>	
  </target>
  <target name="test6bis">
    <sleep seconds="3"/>
    <PCTCompile graphicalMode="${graph}" destDir="build" dlcHome="${env.DLC}" propath="tty">
      <fileset dir=".">
        <include name="sandbox/temp.p"/>	
      </fileset>	
    </PCTCompile>
  </target>

  <!-- Test simple recompile if file has changed (.r timestamp based) -->
  <target name="test7init">
  	<echo file="sandbox/temp.p">
      MESSAGE "Hello world".
  	</echo>
  </target>
  <target name="test7">
    <PCTCompile graphicalMode="${graph}" destDir="build" dlcHome="${env.DLC}" propath="tty">
      <fileset dir=".">
        <include name="sandbox/temp.p"/>	
      </fileset>	
    </PCTCompile>	
  </target>
  <target name="test7bis">
    <sleep seconds="3"/>
    <touch file="sandbox/temp.p"/>
    <PCTCompile graphicalMode="${graph}" destDir="build" dlcHome="${env.DLC}" propath="tty">
      <fileset dir=".">
        <include name="sandbox/temp.p"/>	
      </fileset>	
    </PCTCompile>
  </target>
  
  <!-- Test forceCompile (file has not changed) -->
  <target name="test8init">
  	<echo file="sandbox/temp.p">
      MESSAGE "Hello world".
  	</echo>
  </target>
  <target name="test8">
    <PCTCompile graphicalMode="${graph}" destDir="build" dlcHome="${env.DLC}" propath="tty">
      <fileset dir=".">
        <include name="sandbox/temp.p"/>	
      </fileset>	
    </PCTCompile>	
  </target>
  <target name="test8bis">
    <sleep seconds="3" />
    <PCTCompile graphicalMode="${graph}" destDir="build" dlcHome="${env.DLC}" forceCompile="true" propath="tty">
      <fileset dir=".">
        <include name="sandbox/temp.p"/>	
      </fileset>	
    </PCTCompile>
  </target>
  
  <!-- Test recompile if included file has changed -->
  <target name="test9init">
  	<echo file="sandbox/temp.p">
      {sandbox/temp.i}.
      MESSAGE "World".
  	</echo>
  	<echo file="sandbox/temp.i">
      MESSAGE "Hello".
  	</echo>
  </target>
  <target name="test9">
    <PCTCompile graphicalMode="${graph}" destDir="build" dlcHome="${env.DLC}" propath="tty">
      <fileset dir=".">
        <include name="sandbox/temp.p"/>
      </fileset>
    </PCTCompile>
  </target>
  <target name="test9bis">
    <touch file="sandbox/temp.i"/>
    <sleep seconds="3" />
    <PCTCompile graphicalMode="${graph}" destDir="build" dlcHome="${env.DLC}" forceCompile="true" propath="tty">
      <fileset dir=".">
        <include name="sandbox/temp.p"/>
      </fileset>
    </PCTCompile>
  </target>
  
  <!-- Same as test9 but with spaces in include statement -->
  <target name="test10init">
  	<echo file="sandbox/temp.p">
      {  sandbox/temp.i   }.
      MESSAGE "World".
  	</echo>
  	<echo file="sandbox/temp.i">
      MESSAGE "Hello".
  	</echo>
  </target>
  <target name="test10">
    <PCTCompile graphicalMode="${graph}" destDir="build" dlcHome="${env.DLC}" propath="tty">
      <fileset dir=".">
        <include name="sandbox/temp.p"/>
      </fileset>
    </PCTCompile>	
  </target>
  <target name="test10bis">
    <touch file="sandbox/temp.i"/>
    <sleep seconds="3" />
    <PCTCompile graphicalMode="${graph}" destDir="build" dlcHome="${env.DLC}" forceCompile="true" propath="tty">
      <fileset dir=".">
        <include name="sandbox/temp.p"/>
      </fileset>
    </PCTCompile>
  </target>
  
  <!-- Test failOnError attribute -->
  <target name="test11init">
  	<echo file="sandbox/temp.p">
      MESSGE "Hello World!"
  	</echo>
  	<echo file="sandbox/temp2.p">
      MESSAGE "Hello world!".
  	</echo>
  </target>
  <target name="test11">
    <PCTCompile graphicalMode="${graph}" failOnError="true" destDir="build" dlcHome="${env.DLC}" propath="tty">
      <fileset dir=".">
        <include name="sandbox/temp.p"/>
      </fileset>
      <fileset dir=".">
        <include name="sandbox/temp2.p"/>
      </fileset>
    </PCTCompile>
  </target>

  <!-- Test compileUnderscore attribute -->
  <target name="test12init">
  	<echo file="sandbox/temp.p">
      DEF VAR _c AS CHAR.
  	</echo>
  </target>
  <target name="test12">
    <PCTCompile graphicalMode="${graph}" destDir="build" dlcHome="${env.DLC}" propath="tty">
      <fileset dir=".">
        <include name="sandbox/temp.p"/>
      </fileset>
    </PCTCompile>
  </target>
  <target name="test12bis">
    <PCTCompile graphicalMode="${graph}" destDir="build" dlcHome="${env.DLC}" compileUnderscore="true" propath="tty">
      <fileset dir=".">
        <include name="sandbox/temp.p"/>
      </fileset>
    </PCTCompile>
  </target>
  
  <!-- Test deep includes -->
  <target name="test13init">
    <echo file="sandbox/temp.p">
      {sandbox/temp.i}.
      RETURN '0'.
    </echo>
    <echo file="sandbox/temp.i">
      MESSAGE "Hello".
      {sandbox/temp2.i}.
    </echo>
    <echo file="sandbox/temp2.i">
      MESSAGE "World".
    </echo>
  </target>
  <target name="test13">
    <PCTCompile graphicalMode="${graph}" destDir="build" dlcHome="${env.DLC}" propath="tty">
      <fileset dir=".">
        <include name="sandbox/temp.p"/>
      </fileset>
    </PCTCompile>
  </target>
  <target name="test13bis">
    <sleep seconds="3"/>
    <touch file="sandbox/temp2.i"/>
    <PCTCompile graphicalMode="${graph}" destDir="build" dlcHome="${env.DLC}" propath="tty">
      <fileset dir=".">
        <include name="sandbox/temp.p"/>
      </fileset>
    </PCTCompile>
  </target>
  
  <!-- CRC check -->
  <target name="test14init">
    <echo file="sandbox/schema.df">
      UPDATE DATABASE "?"
      
      ADD TABLE "Tab1"
        AREA "Schema Area"
        LABEL ""
        DESCRIPTION ""
        DUMP-NAME "Tab1"

      ADD FIELD "Fld1" OF "tab1" AS integer 
        FORMAT "9"
        INITIAL "0"
        LABEL "Fld1"
        POSITION 2
        SQL-WIDTH 4
        COLUMN-LABEL "Fld1"
        ORDER 10

      ADD INDEX "Tab1-PK" ON "tab1" 
        AREA "Schema Area"
        UNIQUE
        PRIMARY
        DESCRIPTION "Primary key"
        INDEX-FIELD "Fld1" ASCENDING 
    </echo>
    <PCTCreateBase dbName="test" destDir="sandbox" dlcHome="${env.DLC}" schemaFile="sandbox/schema.df" propath="tty"/>
  </target>
  <target name="test14">
    <echo file="sandbox/test.p">
      CREATE tab1.
      ASSIGN tab1.fld1 = 1.
    </echo>
    <echo file="sandbox/test2.p">
      DEFINE TEMP-TABLE tt NO-UNDO LIKE Tab1.
      CREATE tt.
      ASSIGN tt.fld1 = 1.
    </echo>
    <PCTCompile graphicalMode="${graph}" destDir="build" dlcHome="${env.DLC}" propath="tty">
      <fileset dir=".">
        <include name="sandbox/test*.p"/>
      </fileset>
      <PCTConnection dbName="test" dbDir="sandbox" singleUser="true"/>
    </PCTCompile>
  </target>
  <target name="test14bis">
    <echo file="sandbox/update.df">
      ADD FIELD "Fld2" OF "tab1" AS integer 
        FORMAT "9"
        INITIAL "0"
        LABEL "Fld2"
        POSITION 4
        SQL-WIDTH 4
        COLUMN-LABEL "Fld2"
        ORDER 20
    </echo>
    <PCTLoadSchema graphicalMode="${graph}" srcFile="sandbox/update.df" dlcHome="${env.DLC}" propath="tty">
      <PCTConnection dbName="test" dbDir="sandbox" singleUser="true"/>
    </PCTLoadSchema>
    <sleep seconds="2" />
    <PCTCompile graphicalMode="${graph}" destDir="build" dlcHome="${env.DLC}" propath="tty">
      <fileset dir=".">
        <include name="sandbox/test*.p"/>
      </fileset>
      <PCTConnection dbName="test" dbDir="sandbox" singleUser="true">
        <PCTAlias name="dictdb"/>
      </PCTConnection>
    </PCTCompile>
  </target>

  <!-- CRC check with logical name & aliases -->
  <target name="test15init">
    <echo file="sandbox/schema.df">
      UPDATE DATABASE "?"
      
      ADD TABLE "Tab1"
        AREA "Schema Area"
        LABEL ""
        DESCRIPTION ""
        DUMP-NAME "Tab1"

      ADD FIELD "Fld1" OF "tab1" AS integer 
        FORMAT "9"
        INITIAL "0"
        LABEL "Fld1"
        POSITION 2
        SQL-WIDTH 4
        COLUMN-LABEL "Fld1"
        ORDER 10

      ADD INDEX "Tab1-PK" ON "tab1" 
        AREA "Schema Area"
        UNIQUE
        PRIMARY
        DESCRIPTION "Primary key"
        INDEX-FIELD "Fld1" ASCENDING 
    </echo>
    <PCTCreateBase dbName="test" destDir="sandbox" dlcHome="${env.DLC}" schemaFile="sandbox/schema.df" propath="tty"/>
  </target>
  <target name="test15">
    <echo file="sandbox/test.p">
      CREATE abc.tab1.
      ASSIGN abc.tab1.fld1 = 1.
    </echo>
    <PCTCompile graphicalMode="${graph}" destDir="build" dlcHome="${env.DLC}" propath="tty">
      <fileset dir=".">
        <include name="sandbox/test.p"/>
      </fileset>
      <PCTConnection dbName="test" dbDir="sandbox" singleUser="true" logicalName="abc"/>
    </PCTCompile>
  </target>
  <target name="test15bis">
    <PCTCompile graphicalMode="${graph}" destDir="build" dlcHome="${env.DLC}" propath="tty">
      <fileset dir=".">
        <include name="sandbox/test.p"/>
      </fileset>
      <PCTConnection dbName="test" dbDir="sandbox" singleUser="true" logicalName="abc"/>
    </PCTCompile>
  </target>

  <!-- Test encrypted code with default key can be compiled -->
  <target name="test16init">
  	<echo file="sandbox/temp.p">
      MESSAGE "Hello world".
      RETURN "1".
  	</echo>
    <mkdir dir="xcode"/>
    <PCTXCode destDir="xcode" dlcHome="${env.DLC}">
      <fileset dir="sandbox">
        <include name="temp.p"/>
      </fileset>
    </PCTXCode>
  </target>
  <target name="test16">
    <PCTCompile graphicalMode="${graph}" destDir="build" dlcHome="${env.DLC}" propath="tty">
      <fileset dir=".">
        <include name="sandbox/temp.p"/>
        <include name="xcode/temp.p"/>
      </fileset>
    </PCTCompile>
  </target>

  <!-- Test encrypted code with specified key needs option -->
  <target name="test17init">
  	<echo file="sandbox/temp.p">
      MESSAGE "Hello world".
      RETURN "1".
  	</echo>
    <mkdir dir="xcode"/>
    <PCTXCode destDir="xcode" dlcHome="${env.DLC}" key="pct">
      <fileset dir="sandbox">
        <include name="temp.p"/>
      </fileset>
    </PCTXCode>
  </target>
  <target name="test17-part1">
    <PCTCompile graphicalMode="${graph}" destDir="build" dlcHome="${env.DLC}" propath="tty" xcode="true">
      <fileset dir=".">
        <include name="xcode/temp.p"/>
      </fileset>
    </PCTCompile>
  </target>
  <target name="test17-part2">
    <PCTCompile graphicalMode="${graph}" destDir="build" dlcHome="${env.DLC}" propath="tty" xcode="true" xcodekey="pct">
      <fileset dir=".">
        <include name="xcode/temp.p"/>
      </fileset>
    </PCTCompile>
  </target>
  
</project>
