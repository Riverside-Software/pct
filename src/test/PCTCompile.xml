<?xml version="1.0"?>

<project name="PCTCompile-test" default="">

  <taskdef name="PCTCompile" classname="com.phenix.pct.PCTCompile" classpath="../../lib/PCT.jar"/>

  <property environment="env"/>
  
  <!-- Should throw BuildException : no dest dir -->
  <target name="test1">
    <PCTCompile/>
  </target>
  
  <!-- Do nothing : should not hurt -->
  <target name="test2">
    <PCTCompile destDir="build" dlcHome="${env.DLC}">
      <propath>
        <pathelement path="../../build/tty"/>	
      </propath>
    </PCTCompile>
  </target>
  
  <!-- Simple compilation -->
  <target name="test3">
    <echo file="sandbox/test.p">
      MESSAGE "Hello world!".
      RETURN "0".
    </echo>
    <PCTCompile destDir="build" dlcHome="${env.DLC}">
      <fileset dir=".">
        <include name="sandbox/test.p"/>	
      </fileset>	
      <propath>
        <pathelement path="../../build/tty"/>	
      </propath>
    </PCTCompile>	
  </target>
  
  <!-- Simple failed compilation -->
  <target name="test3bis">
  	<echo file="sandbox/temp.p">
      MESSGE "Hello world!".
  	</echo>
    <PCTCompile destDir="build" dlcHome="${env.DLC}">
      <fileset dir=".">
        <include name="sandbox/temp.p"/>	
      </fileset>
      <propath>
        <pathelement path="../../build/tty"/>	
      </propath>
    </PCTCompile>	
  </target>
  <target name="test3post">
    <delete file="progress/temp.p"/>	
  </target>
  
  <!-- Test MIN-SIZE attribute -->
  <target name="test4">
    <echo file="sandbox/test.p">
      MESSAGE "Hello world!".
      RETURN "0".
    </echo>
    <PCTCompile destDir="build" dlcHome="${env.DLC}">
      <fileset dir=".">
        <include name="sandbox/test.p"/>	
      </fileset>	
      <propath>
        <pathelement path="../../build/tty"/>	
      </propath>
    </PCTCompile>	
  </target>
  <target name="test4bis">
    <echo file="sandbox/test.p">
      MESSAGE "Hello world!".
      RETURN "0".
    </echo>
    <PCTCompile destDir="build" dlcHome="${env.DLC}" minSize="true">
      <fileset dir=".">
        <include name="sandbox/test.p"/>	
      </fileset>	
      <propath>
        <pathelement path="../../build/tty"/>	
      </propath>
    </PCTCompile>	
  </target>
  
  <!-- Test escape string -->
  <target name="test5">
    <echo file="sandbox/wizz~~'~.p">
      MESSAGE "Hello world!".
      RETURN "0".
    </echo>
    <PCTCompile destDir="build" dlcHome="${env.DLC}">
      <fileset dir=".">
        <include name="sandbox/wizz~~'~.p"/>	
      </fileset>	
      <propath>
        <pathelement path="../../build/tty"/>	
      </propath>
    </PCTCompile>	
  </target>

  <!-- Test no recompile if file not changed (.r timestamp based) -->
  <target name="test6init">
  	<echo file="sandbox/temp.p">
      MESSAGE "Hello world".
  	</echo>
  </target>
  <target name="test6">
    <PCTCompile destDir="build" dlcHome="${env.DLC}">
      <fileset dir=".">
        <include name="sandbox/temp.p"/>	
      </fileset>	
      <propath>
        <pathelement path="../../build/tty"/>	
      </propath>
    </PCTCompile>	
  </target>
  <target name="test6bis">
    <PCTCompile destDir="build" dlcHome="${env.DLC}">
      <fileset dir=".">
        <include name="sandbox/temp.p"/>	
      </fileset>	
      <propath>
        <pathelement path="../../build/tty"/>	
      </propath>
    </PCTCompile>
    <delete file="progress/temp.p"/>
  </target>

  <!-- Test simple recompile if file has changed (.r timestamp based) -->
  <target name="test7init">
  	<echo file="sandbox/temp.p">
      MESSAGE "Hello world".
  	</echo>
  </target>
  <target name="test7">
    <PCTCompile destDir="build" dlcHome="${env.DLC}">
      <fileset dir=".">
        <include name="sandbox/temp.p"/>	
      </fileset>	
      <propath>
        <pathelement path="../../build/tty"/>	
      </propath>
    </PCTCompile>	
  </target>
  <target name="test7bis">
  	<touch file="sandbox/temp.p"/>
    <PCTCompile destDir="build" dlcHome="${env.DLC}">
      <fileset dir=".">
        <include name="sandbox/temp.p"/>	
      </fileset>	
      <propath>
        <pathelement path="../../build/tty"/>	
      </propath>
    </PCTCompile>
    <delete file="progress/temp.p"/>
  </target>
  
  <!-- Test forceCompile (file has not changed) -->
  <target name="test8init">
  	<echo file="sandbox/temp.p">
      MESSAGE "Hello world".
  	</echo>
  </target>
  <target name="test8">
    <PCTCompile destDir="build" dlcHome="${env.DLC}">
      <fileset dir=".">
        <include name="sandbox/temp.p"/>	
      </fileset>	
      <propath>
        <pathelement path="../../build/tty"/>	
      </propath>
    </PCTCompile>	
  </target>
  <target name="test8bis">
    <PCTCompile destDir="build" dlcHome="${env.DLC}" forceCompile="true">
      <fileset dir=".">
        <include name="sandbox/temp.p"/>	
      </fileset>	
      <propath>
        <pathelement path="../../build/tty"/>	
      </propath>
    </PCTCompile>
    <delete file="sandbox/temp.p"/>
  </target>
  
  <!-- Test recompile if included file has changed -->
  <target name="test9init">
  	<echo file="sandbox/temp.p">
      {sandbox/temp.i}.
      MESSAGE "World".
  	</echo>
  	<echo file="sandbox/temp.i">
      MESSAGE "Hello".
  	</echo>
  </target>
  <target name="test9">
    <PCTCompile destDir="build" dlcHome="${env.DLC}">
      <fileset dir=".">
        <include name="sandbox/temp.p"/>	
      </fileset>	
      <propath>
        <pathelement path="../../build/tty"/>	
      </propath>
    </PCTCompile>	
  </target>
  <target name="test9bis">
  	<touch file="sandbox/temp.i"/>
    <PCTCompile destDir="build" dlcHome="${env.DLC}" forceCompile="true">
      <fileset dir=".">
        <include name="sandbox/temp.p"/>	
      </fileset>	
      <propath>
        <pathelement path="../../build/tty"/>	
      </propath>
    </PCTCompile>
    <delete file="sandbox/temp.i"/>
    <delete file="sandbox/temp.p"/>
  </target>
  
  <!-- Same as test9 but with spaces in include statement -->
  <target name="test10init">
  	<echo file="sandbox/temp.p">
      {  sandbox/temp.i   }.
      MESSAGE "World".
  	</echo>
  	<echo file="sandbox/temp.i">
      MESSAGE "Hello".
  	</echo>
  </target>
  <target name="test10">
    <PCTCompile destDir="build" dlcHome="${env.DLC}">
      <fileset dir=".">
        <include name="sandbox/temp.p"/>	
      </fileset>	
      <propath>
        <pathelement path="../../build/tty"/>	
      </propath>
    </PCTCompile>	
  </target>
  <target name="test10bis">
  	<touch file="sandbox/temp.i"/>
    <PCTCompile destDir="build" dlcHome="${env.DLC}" forceCompile="true">
      <fileset dir=".">
        <include name="sandbox/temp.p"/>	
      </fileset>	
      <propath>
        <pathelement path="../../build/tty"/>	
      </propath>
    </PCTCompile>
    <delete file="sandbox/temp.i"/>
    <delete file="sandbox/temp.p"/>
  </target>
  
  <!-- Test failOnError attribute -->
  <target name="test11init">
  	<echo file="sandbox/temp.p">
      MESSGE "Hello World!"
  	</echo>
  	<echo file="sandbox/temp2.p">
      MESSAGE "Hello world!".
  	</echo>
  </target>
  <target name="test11">
    <PCTCompile destDir="build" dlcHome="${env.DLC}">
      <fileset dir=".">
        <include name="sandbox/temp.p"/>
      </fileset>	
      <propath>
        <pathelement path="../../build/tty"/>	
      </propath>
    </PCTCompile>	
    <PCTCompile destDir="build" dlcHome="${env.DLC}">
      <fileset dir=".">
        <include name="sandbox/temp2.p"/>
      </fileset>	
      <propath>
        <pathelement path="../../build/tty"/>	
      </propath>
    </PCTCompile>	
  </target>
  <target name="test11post">
    <delete file="sandbox/temp.p"/>
    <delete file="sandbox/temp2.p"/>
  </target>
  
  <!-- Test compileUnderscore attribute -->
  <target name="test12init">
  	<echo file="sandbox/temp.p">
      DEF VAR _c AS CHAR.
  	</echo>
  </target>
  <target name="test12">
    <PCTCompile destDir="build" dlcHome="${env.DLC}">
      <fileset dir=".">
        <include name="sandbox/temp.p"/>
      </fileset>	
      <propath>
        <pathelement path="../../build/tty"/>	
      </propath>
    </PCTCompile>
  </target>
  <target name="test12bis">
    <PCTCompile destDir="build" dlcHome="${env.DLC}" compileUnderscore="true">
      <fileset dir=".">
        <include name="sandbox/temp.p"/>
      </fileset>	
      <propath>
        <pathelement path="../../build/tty"/>	
      </propath>
    </PCTCompile>	
  </target>
  <target name="test12post">
    <delete file="sandbox/temp.p"/>
  </target>
  
</project>
