<?xml version="1.0" encoding="utf-8"?>

<project name="PCT" default="dist">

  <!-- Give user a chance to override without editing this file
       (and without typing -D each time it compiles it) -->
  <property file=".pct.properties" />
  <property file="${user.home}/.pctrc" />
  <property environment="env" />

  <!-- Some directories definitions -->
  <property name="src.java" location="src/java" />
  <property name="src.progress" location="src/progress" />
  <property name="src.test" location="src/test" />
  <property name="build" location="build" />
  <property name="dist" location="lib" />
  <property name="doc" location="javadoc" />
  <property name="check" location="check" />
  <property name="website" location="website" />
  <property name="testdir" location="testbox" />
  <property name="junit" location="junit-report" />
  
  <!-- Properties that control various build options -->
  <property name="debug" value="true" />
  <property name="deprecation" value="false" />
  <property name="optimize" value="false" />
  <property name="javac.source" value="1.2" />
  <property name="javac.target" value="1.2" />

  <!-- PCT Version -->
  <property name="pct.version" value="0.10-pre" />

  <!-- If $DLC/servlets is here, we're using Progress v10 -->
  <available file="${env.DLC}/servlets" type="dir" property="dlc.version" value="dlc10" />
  <!-- Not here ? We're using Progress v9 -->
  <condition property="dlc.version" value="dlc9">
    <not><isset property="dlc.version" /></not>  
  </condition>

  <tstamp>
    <format property="year" pattern="yyyy" />
  </tstamp>

  <target name="init" description="Creates required directories">
    <mkdir dir="${build}" />
    <mkdir dir="${dist}" />
  </target>

  <target name="build" depends="init" description="Java source files compilation">
    <javac srcdir="${src.java}" destdir="${build}" debug="${debug}" source="${javac.source}" target="${javac.target}" deprecation="${deprecation}" optimize="${optimize}">
      <include name="com/phenix/pct/*.java" />
      <include name="net/cordova/prounit/*.java" />
    </javac>
    <copy todir="${build}">
      <fileset dir="${src.java}" includes="**/*.properties" />
    </copy>
  </target>

  <target name="jar" depends="build" description="JAR file generation">
    <jar jarfile="${dist}/PCT.jar">
      <fileset dir="${build}">
        <include name="com/phenix/pct/*.class" />
      	<include name="com/phenix/pct/*.properties" />
        <include name="net/cordova/prounit/*.class" />
        <include name="PCT.properties" />
        <exclude name="com/phenix/pct/*Test.class" />
      </fileset>
      <manifest>
        <attribute name="Built-By" value="${user.name}" />
        <section name="common">
          <attribute name="Specification-Title" value="PCT" />
          <attribute name="Specification-Version" value="${pct.version}" />
          <attribute name="Specification-Vendor" value="Phenix Engineering" />
          <attribute name="Implementation-Title" value="PCT" />
          <attribute name="Implementation-Version" value="${pct.version} ${TODAY}" />
          <attribute name="Implementation-Vendor" value="Phenix Engineering" />
        </section>
      </manifest>
    </jar>
  </target>

  <target name="declare" depends="jar" description="PCT tasks declaration">
    <taskdef resource="PCT.properties" classpath="${dist}/PCT.jar" />
  </target>

  <target name="pbuild" depends="declare" description="Progress code compilation">
    <PCTCompile destdir="${build}/tty" md5="true" minSize="true" graphicalMode="false" dlcHome="${env.DLC}">
      <fileset dir="${src.progress}">
        <include name="pct/*.p" />
      </fileset>
      <propath>
        <pathelement location="${src.progress}" />
      </propath>
    </PCTCompile>
    <copy todir="${build}/tty">
      <fileset dir="${src.progress}">
        <include name="prodict/**/*.p" />
        <include name="prodict/**/*.i" />
        <include name="adecomm/*.i" />
      </fileset>
    </copy>
    <PCTCompile destdir="${build}/gui" md5="true" minSize="true" graphicalMode="true" dlcHome="${env.DLC}">
      <fileset dir="${src.progress}">
        <include name="pct/*.p" />
      </fileset>
      <propath>
        <pathelement location="${src.progress}" />
      </propath>
    </PCTCompile>
    <copy todir="${build}/gui">
      <fileset dir="${src.progress}">
        <include name="prodict/**/*.p" />
        <include name="prodict/**/*.i" />
        <include name="adecomm/*.i" />
      </fileset>
    </copy>
  </target>

  <target name="check" depends="build" description="Check source code convention">
    <taskdef resource="checkstyletask.properties" />
    <mkdir dir="${check}" />
    <checkstyle config="conf/check-config.xml" failOnViolation="false">
      <formatter type="xml" toFile="${check}/check.xml" />
      <fileset dir="${src.java}" includes="com/phenix/pct/*.java" />
      <!--<fileset dir="${src.test}" includes="com/phenix/pct/*.java"/>-->
    </checkstyle>
    <style in="${check}/check.xml" style="conf/checkstyle-simple.xsl" out="${check}/output.html" />
  </target>

  <target name="test-build" depends="pbuild" description="Builds junit tests">
    <javac srcdir="${src.test}" destdir="${build}" debug="${debug}" source="${javac.source}" target="${javac.target}" deprecation="${deprecation}" optimize="${optimize}">
      <include name="org/apache/tools/ant/*.java" />
      <include name="com/phenix/pct/*.java" />
      <include name="net/cordova/prounit/*.java" />
      <classpath>
        <pathelement location="${build}" />
        <pathelement location="junit.jar" />
      </classpath>
    </javac>
  </target>

  <target name="prepare-test" depends="test-build" description="Prepares tests (copy files and taskdef)">
  	<!-- Copy Progress files so that there isn't a conflict if PCT is already installed -->
    <mkdir dir="${testdir}" />
  	<copy todir="${testdir}">
  	  <fileset dir="${src.test}" includes="*.xml,*.pxg,*.xpxg,ubroker.template,conmgr.template" />
      <fileset dir="src" includes="progress/**" />
  	</copy>
    <!-- New taskdef... JUnit testing ANT tasks is a real pain... -->
    <!-- To have consistent behavior between command line ANT and eclipse -->
  	<!-- WARNING 1 : If you want to run this task from command line, be sure to remove -->
  	<!-- ant-junit.jar from you %ANT_HOME%/lib directory -->
  	<!-- WARNING 2 : If you want to run this task from Eclipse's Ant plugin, be sure to -->
  	<!-- remove ant-junit.jar from your ClassPath : Window -> Preferences, section Ant -> Runtime -->
  	<!-- Classpath tab, and remove ant-junit.jar from Ant Home Entries -->
  	<!-- WARNING 3 : If you want to run tests from Eclipse's JUnit plugin, be sure to add -->
  	<!-- the followings : -->
  	<!--  * In Arguments tab, working directory should be set to ${workspace_loc:PCT/testbox} -->
  	<!--  * In Classpath tab, add ant-junit and ant-launcher in User Entries -->
  	<!--  * In Environment entries, add a DLC variable pointing to your DLC installation -->
  	<!--  * And remember you always have to run the prepare-test task ... -->
  	<!--<taskdef name="junit" classname="org.apache.tools.ant.taskdefs.optional.junit.JUnitTask" onerror="report">
      <classpath>
        <pathelement location="${basedir}/ant-junit.jar" />
        <pathelement location="${basedir}/junit.jar" />
        <pathelement location="${basedir}/ant-launcher.jar" />
      </classpath>
    </taskdef>-->
  </target>
  	
  <target name="test" depends="prepare-test" description="Starts tests">
    <junit printsummary="yes" haltonfailure="no" filtertrace="off" fork="yes" dir="${testdir}" showoutput="true">
      <classpath>
        <pathelement location="${build}" />
      </classpath>
      <formatter type="xml" />
      <batchtest>
        <fileset dir="${build}">
          <include name="com/phenix/pct/PCT*Test.class" />
          <!-- A few problems for now... -->
          <!--<include name="net/cordova/prounit/*Test.class" />-->
        </fileset>
      </batchtest>
    </junit>
    <junitreport>
      <fileset dir="${basedir}">
        <include name="TEST-*.xml"/>
      </fileset>
      <report format="frames" styledir="${basedir}" todir="${junit}"/>
    </junitreport>
    <delete>
      <fileset dir="." includes="TEST-*.xml" />
    </delete>
  </target>

  <target name="javadoc" depends="build" description="API documentation creation">
    <mkdir dir="${doc}" />
    <javadoc destdir="${doc}" useexternalfile="yes">
      <packageset dir="${src.java}" />
      <group title="PCT Core" packages="com.phenix.pct.*" />
      <bottom>Copyright &#169; 2003-${year} Gilles QUERRET. All Rights Reserved.</bottom>
      <link href="http://java.sun.com/j2se/1.4.2/docs/api/" />
      <!-- Seems down -->
      <!--<link href="http://nagoya.apache.org/gump/javadoc/ant/build/javadocs/"/>-->
    </javadoc>
  </target>

  <target name="bindist" depends="jar,pbuild,website" description="Generates binary zip/tarball archive">
    <zip destfile="pct-bin-${pct.version}-${dlc.version}.zip">
      <zipfileset prefix="pct" dir="." filemode="644">
        <include name="lib/PCT.jar" />
        <include name="CHANGELOG" />
        <include name="website/**" />
      </zipfileset>
      <zipfileset prefix="pct" dir="build" filemode="644">
        <include name="tty/**/*.r" />
        <include name="tty/**/*.i" />
        <include name="tty/**/*.p" />
        <include name="gui/**/*.r" />
        <include name="gui/**/*.i" />
        <include name="gui/**/*.p" />
      </zipfileset>
    </zip>
  </target>

  <target name="srcdist" description="Generates source zip/tarball archive">
    <zip destfile="pct-src-${pct.version}.zip">
      <zipfileset prefix="pct" dir="." filemode="644">
        <include name="src/**" />
        <include name="build.xml" />
        <include name="conf/**" />
        <include name="doc/**" />
        <include name="CHANGELOG" />
      </zipfileset>
    </zip>
  </target>

  <target name="dist" depends="srcdist,bindist" />

  <target name="clean" description="Nettoyage">
    <delete dir="${build}" />
    <delete dir="${dist}" />
    <delete dir="${doc}" />
    <delete dir="${check}" />
    <delete dir="${website}" />
    <delete dir="${testdir}" />
    <delete dir="sports2000" />
    <delete dir="${junit}" />
    <delete>
      <fileset dir=".">
        <include name="pct*.tar.gz" />
        <include name="pct*.zip" />
        <include name="TEST*.xml" />
      </fileset>
    </delete>
  </target>

  <target name="website" depends="javadoc,sports2000doc,test" description="Generates files used for the pct.sf.net website">
    <delete dir="${website}" />
    <mkdir dir="${website}" />
    <loadfile property="right-banner" srcFile="${basedir}/doc/right-banner.include"/>
    <copy todir="${website}">
      <fileset dir="doc">
        <include name="*.html" />
        <include name="*.css" />
        <include name="*.xsl" />
      </fileset>
      <fileset dir=".">
        <include name="CHANGELOG" />
        <include name="${doc}/**" />
      </fileset>
      <filterset>
        <filter token="RIGHT_BANNER" value="${right-banner}"/>
      </filterset>
    </copy>
    <copy todir="${website}">
      <fileset dir="doc">
        <include name="back.png" />
        <include name="ss*.png" />
      </fileset>
    </copy>
    <copy todir="${website}/sports2000">
      <fileset dir="sports2000/doc">
        <include name="**" />
      </fileset>
    </copy>
    <copy todir="${website}/junit">
      <fileset dir="${junit}">
        <include name="**" />
      </fileset>
    </copy>
    <copy todir="${website}/javadoc">
      <fileset dir="${doc}">
        <include name="**" />
      </fileset>
    </copy>
    <zip destfile="${website}/sample1.zip" whenempty="create">
      <zipfileset dir="doc/quickstart-samples/step1" prefix="MyProject" />
    </zip>
    <zip destfile="${website}/sample2.zip" whenempty="create">
      <zipfileset dir="doc/quickstart-samples/step2" prefix="MyProject" />
    </zip>
    <zip destfile="${website}/sample3.zip" whenempty="create">
      <zipfileset dir="doc/quickstart-samples/step3" prefix="MyProject" />
    </zip>
    <zip destfile="${website}/sample4.zip" whenempty="create">
      <zipfileset dir="doc/quickstart-samples/step4" prefix="MyProject" />
    </zip>
    <zip destfile="${website}/sample5.zip" whenempty="create">
      <zipfileset dir="doc/quickstart-samples/step5" prefix="MyProject" />
    </zip>
  </target>

  <target name="sports2000doc" depends="pbuild">
    <mkdir dir="sports2000" />
    <mkdir dir="sports2000/doc" />
    <mkdir dir="sports2000/doc/files" />
    <property name="sports2000-doc" location="sports2000/doc" />
    <exec executable="${env.DLC}/bin/_dbutil" dir="sports2000">
      <env key="DLC" value="${env.DLC}" />
      <arg value="procopy" />
      <arg path="${env.DLC}/sports2000" />
      <arg value="sports2000" />
    </exec>
    <PCTSchemaDoc file="sports2000/sports2000.xml" dlcHome="${env.DLC}" propath="${build}/tty">
      <PCTConnection dbDir="sports2000" dbName="sports2000" singleUser="true" />
    </PCTSchemaDoc>
    <style in="sports2000/sports2000.xml" style="doc/SchemaDoc.xsl" out="sports2000/output.txt">
      <param name="outputdir" expression="${sports2000-doc}" />
    </style>
  </target>

  <target name="upload" depends="website" description="Quick reminder on how to upload files">
    <scp todir="${username}:${password}@shell.sourceforge.net:/home/groups/p/pc/pct/htdocs/">
      <fileset dir="website" />
    </scp>
    <ftp userid="anonymous" password="" server="upload.sourceforge.net" binary="true" remotedir="/incoming">
      <fileset dir="." includes="pct*.zip" />
    </ftp>
  </target>
  
</project>
