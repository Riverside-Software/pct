<?xml version="1.0"?>

<project name="PCT" default="bindist">
  
  <!-- Give user a chance to override without editing this file
       (and without typing -D each time it compiles it) -->
  <property file=".pct.properties"/>
  <property file="${user.home}/.pctrc"/>
  <property environment="env"/>
  
  <!-- Some directories definitions -->
  <property name="src.java" value="src/java"/>
  <property name="src.progress" value="src/progress"/>
  <property name="src.test" value="src/test"/>
  <property name="build" value="build"/>
  <property name="dist" value="lib"/>
  <property name="doc" value="javadoc"/>
  <property name="check" value="check"/>  
  <property name="website" value="website"/>
  
  <!-- Jalopy classpath -->
  <path id="JalopyCP">
    <fileset dir="${env.JALOPY_HOME}/lib">
      <include name="*.jar"/>
    </fileset>
  </path>

  <!-- Jalopy task definition -->
  <taskdef name="jalopy" classname="de.hunsicker.jalopy.plugin.ant.AntPlugin">
    <classpath refid="JalopyCP"/>
  </taskdef>
  
  <!-- Checkstyle task definition -->
  <taskdef resource="checkstyletask.properties" classpath="${env.CHECKSTYLE_HOME}/checkstyle-all-3.1.jar"/>

  <target name="init" description="Creates required directories">
    <mkdir dir="${build}"/>
    <mkdir dir="${dist}"/>
    <mkdir dir="${doc}"/>
  </target>

  <target name="build" depends="init" description="Java source files compilation">
    <javac srcdir="${src.java}" destdir="${build}" includes="com/phenix/pct/*.java" debug="false" target="1.1"/>
  </target>

  <target name="jar" depends="build" description="JAR file generation">
    <jar jarfile="${dist}/PCT.jar">
      <fileset dir="${build}">
        <include name="com/phenix/pct/*.class"/>
        <exclude name="com/phenix/pct/*Test.class"/>
      </fileset>
      <fileset dir="${src.java}">
        <include name="PCT.properties"/>
      </fileset>
    </jar>
  </target>
  
  <target name="declare" depends="jar" description="PCT tasks declaration">
    <taskdef resource="PCT.properties" classpath="${dist}/PCT.jar"/>
  </target>
  
  <target name="pbuild" depends="declare" description="Progress code compilation">
    <PCTCompile destdir="${build}/tty" md5="true" minSize="true" graphicalMode="false" dlcHome="${env.DLC}">
      <fileset dir="${src.progress}">
        <include name="pct/*.p"/>
      </fileset>
      <propath>
        <pathelement location="${src.progress}"/>
      </propath>
    </PCTCompile>
    <PCTCompile destdir="${build}/gui" md5="true" minSize="true" graphicalMode="true" dlcHome="${env.DLC}">
      <fileset dir="${src.progress}">
        <include name="pct/*.p"/>
      </fileset>
      <propath>
        <pathelement location="${src.progress}"/>
      </propath>
    </PCTCompile>
  </target>
  
  <target name="format" depends="build,test-build" description="Java source code formatting">
    <jalopy fileformat="unix" encoding="utf-8" history="file" historymethod="adler32" convention="conf/jalopy.xml">
      <fileset dir="${src.java}">
        <include name="com/phenix/pct/**/*.java" />
      </fileset>
      <fileset dir="${src.test}">
        <include name="com/phenix/pct/**/*.java" />
      </fileset>
    </jalopy>
  </target>

  <target name="check" depends="format" description="Check source code convention">
    <mkdir dir="${check}"/>
    <checkstyle config="conf/check-config.xml" failOnViolation="false">
      <formatter type="xml" toFile="${check}/check.xml"/>
      <fileset dir="${src.java}" includes="com/phenix/pct/*.java"/>
      <fileset dir="${src.test}" includes="com/phenix/pct/*.java"/>
    </checkstyle>
    <style in="${check}/check.xml" style="conf/checkstyle-simple.xsl" out="${check}/output.html"/>
  </target>

  <target name="test-build" depends="jar" description="Builds junit tests">
    <javac srcdir="${src.test}" destdir="${build}" debug="true">
      <include name="org/apache/tools/ant/*.java"/>
      <include name="com/phenix/pct/*.java"/>
      <classpath>
        <pathelement location="${build}"/>
      </classpath>
    </javac>
  </target>
  
  <target name="test" depends="test-build" description="Starts tests">
    <junit printsummary="no" haltonfailure="yes" filtertrace="off">
      <classpath>
        <pathelement location="${build}"/>
      </classpath>

      <formatter type="brief" usefile="false"/>

      <batchtest>
        <fileset dir="src/test">
          <include name="com/phenix/pct/*Test*"/>
        </fileset>
      </batchtest>
    </junit>
  </target>

  <target name="javadoc" depends="build" description="API documentation creation">
    <javadoc destdir="${doc}" useexternalfile="yes">
      <packageset dir="${src.java}"/>
      <group title="PCT Core" packages="com.phenix.pct.*"/>
      <bottom>Copyright &#169; 2003-${year} Gilles QUERRET. All Rights Reserved.</bottom>
    </javadoc>
  </target>

  <target name="bindist" depends="jar,pbuild,website" description="Generates binary zip/tarball archive">
    <tar destfile="pct-bin.tar.gz" compression="gzip">
      <tarfileset prefix="pct" dir="." mode="644">
        <include name="${dist}/PCT.jar"/>
        <include name="doc/**"/>
        <include name="CHANGELOG"/>
        <include name="website/**"/>
      </tarfileset>
      <tarfileset prefix="pct" dir="build" mode="644">
        <include name="tty/pct/*.r"/>
        <include name="gui/pct/*.r"/>
      </tarfileset>
    </tar>
    <zip destfile="pct-bin.zip">
      <zipfileset prefix="pct" dir="." filemode="644">
        <include name="${dist}/PCT.jar"/>
        <include name="doc/**"/>
        <include name="CHANGELOG"/>
        <include name="website/**"/>
      </zipfileset>
      <zipfileset prefix="pct" dir="build" filemode="644">
        <include name="tty/pct/*.r"/>
        <include name="gui/pct/*.r"/>
      </zipfileset>
    </zip>
  </target>
  
  <target name="srcdist" description="Generates source zip/tarball archive">
    <tar destfile="pct-src.tar.gz" compression="gzip">
      <tarfileset prefix="pct" dir="." mode="644">
        <include name="src/**"/>
        <include name="build.xml"/>
        <include name="conf/**"/>
        <include name="doc/**"/>
        <include name="CHANGELOG"/>
      </tarfileset>
    </tar>
    <zip destfile="pct-src.zip">
      <zipfileset prefix="pct" dir="." filemode="644">
        <include name="src/**"/>
        <include name="build.xml"/>
        <include name="conf/**"/>
        <include name="doc/**"/>
        <include name="CHANGELOG"/>
      </zipfileset>
    </zip>
  </target>
  
  <target name="clean" description="Nettoyage">
    <delete dir="${build}"/>
    <delete dir="${dist}"/>
    <delete dir="${doc}"/>
    <delete dir="${check}"/>
  </target>
  
  <target name="website" depends="javadoc" description="Generates files used for the pct.sf.net website">
    <delete dir="${website}"/>
    <mkdir dir="${website}"/>
    <copy toDir="${website}">
      <fileset dir="doc">
        <include name="*.html"/>
        <include name="*.css"/>
      </fileset>
      <fileset dir=".">
        <include name="CHANGELOG"/>
        <include name="${doc}/**"/>
      </fileset>
    </copy>
  </target>
  
</project>
